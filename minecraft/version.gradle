def getExecOutput(commands) {
    def out = new ByteArrayOutputStream()
    exec {
        commandLine commands
        standardOutput out
    }
    return out.toString().trim();
}

def getEnvAsBoolean(name) {
    return System.getenv(name) && System.getenv(name).toBoolean()
}


def getBuildVersion() {
    if (getEnvAsBoolean('CI')) {
        project.ext.ci = true
        if (getEnvAsBoolean('GITHUB_ACTIONS')) {
            def dev =  getEnvAsBoolean('IS_RELEASE') ? '' : 'dev-'
            def sha =  System.getenv('GITHUB_SHA').substring(0, 7)
            def buildNumber = System.getenv('GITHUB_RUN_NUMBER')
            return "${dev}rev.${sha}-build.${buildNumber}"
        } else {
            return System.getenv('CI_VERSION')
        }
    } else {
        def sha = getExecOutput(['git', 'rev-parse', '--verify', '--short', 'HEAD'])
        def dirty = getExecOutput(['git', 'status', '--short']).isEmpty() ? '' : '-dirty'
        return "dev-rev.${sha}-build.0${dirty}"
    }
}


project.ext.baseVersion = "${minecraft_version}-${project.modVersion}"
project.ext.fullVersion = "${baseVersion}-${getBuildVersion()}"
project.version = getEnvAsBoolean('IS_RELEASE') ? baseVersion : fullVersion

println('Java: ' + System.getProperty('java.version') + ' JVM: ' + System.getProperty('java.vm.version') + '(' + System.getProperty('java.vendor') + ') Arch: ' + System.getProperty('os.arch'))
logger.lifecycle("Project version: ${project.version}")
logger.lifecycle("Full version: ${fullVersion}")
